\subsection{Details of the Algorithm}
\label{sec:description}

\input{c05/pseudocode-localrecovery}

A pseudo-code of the local recovery algorithm is given in \pseudosref{local-data|structures}{local-seek:modify}. The pseudo-code only shows the seek phase of an algorithm and not its execution phase since the execution phase is algorithm-specific. We have also moved the pseudo-code for local recovery when looking for a successor key to the appendix due to lack of space.


The local recovery algorithm assumes that the original algorithm supports the following functions:
\begin{enumerate*}[label=(\alph*)]
%%
\item \GetKey(~), \IsMarked(~) and \GetChild(~) returns the various attributes of a tree node,
\item \IsNull(~) returns true if a reference is null and false otherwise,
\item \GetAddress(~) returns the node address stored in a reference, if non-null,
\item \Move(~) enables the original algorithm to move along an edge, which may invoke helping and restarting of the traversal as in~\cite{HowJon:2012:SPAA},
\item \NeedCleanParentNode(~) returns true if the operation needs the parent node to be clean and have no operation in progress (needed for a delete operation since it needs to modify a child pointer at the parent node), and
\item \PopulateSeekRecord(~) copies the relevant information from the traversal state required by the algorithm into a seek record.
\end{enumerate*}

\begin{comment}
\NeedSuccessorKey(~) evaluates if the successor key is still needed for the target key and returns a reference which is null if no successor key is needed and an address of the terminal node's right child otherwise
\end{comment}

\Pseudoref{local-data|structures} shows the data structures used by the local recovery algorithm. Note that all the data structures shown in \Pseudoref{local-data|structures} are \emph{local} to a process not shared among processes. A process uses three main data structures, namely \TraversalRecord{}, \OpRecord{} and \SeekRecord{}. A \TraversalRecord{} (\linesref{local-traversal|record:begin}{local-traversal|record:end}) is essentially a stack used to store the nodes visited during tree traversal when looking for a key (target or successor). Note that the traversal stack satisfies the last-in-first-out (LIFO) semantics but our algorithm sometimes uses it in a non-traditional way by accessing entries in the middle of the stack. One way to implement such an ``augmented'' stack is to use an auto-resizing vector provided as part of C++ STL library or Java package. Each entry in a traversal stack (\linesref{local-stack|entry:begin}{local-stack|entry:end}) stores the address of the node, the location of its closest \myanchor{} node (within the stack's vector) and whether the node is a left or right child of its parent. An \OpRecord{} (\linesref{local-op|record:begin}{local-op|record:end}) stores information about the operation such as type and key as well two stacks: one used when looking for the target key (all operations) and one used when looking for the successor key (only complex delete operations). Finally, a \SeekRecord{} (\linesref{local-seek|record:begin}{local-seek|record:end}) is used to return the outcome of a tree traversal to the original algorithm. Its fields are algorithm-specific. For example, for \CASTLE{}, \SeekRecord{} contains three fields: 
\begin{enumerate*}[label=(\alph*)]
\item two addresses, namely those of the target node and its parent, and
\item the contents of the injection point where an insert operation needs to attach the new node. 
\end{enumerate*}

\Pseudoref{local-stack|functions} shows the functions used to manipulate a traversal stack. The function \Size{} (\linesref{local-size:begin}{local-size:end}) returns the number of entries in the stack. The functions \GetTop{} (\linesref{local-get|top:begin}{local-get|top:end}) and \GetSecondToTop{} (\linesref{local-get|second|to|top:begin}{local-get|second|to|top:end}) return the address of the node stored in the topmost entry and the entry below it, respectively. The function \AddToTop{} (\linesref{local-add|to|top:begin}{local-add|to|top:end}) adds an entry to the top of the stack while \RemoveFromTop{} (\linesref{local-remove|from|top:begin}{local-remove|from|top:end}) removes an entry from the top of the stack. The function \RemoveUntilCritical{} (\linesref{local-remove|until|critical:begin}{local-remove|until|critical:end}) removes the entries from the top of the stack until a given point. The function \RememberCritical{} (\linesref{local-remember|critical:begin}{local-remember|critical:end}) updates the \myanchor{} field of the \myanchor{} node of the topmost entry in the stack. The function \GetFullEntry{} (\linesref{local-get|full|entry:begin}{local-get|full|entry:end} returns all the three fields of a given entry in the stack (may not be the topmost entry). The function \InitializeTraversalRecord{} (\linesref{local-initialize|traversal|record:begin}{local-initialize|traversal|record:end}) initializes a traversal stack. The stack for target key %is initialized using sentinel nodes while the stack for successor key is initialized as empty.

\Pseudosref[ \& ] {local-seek:search}{local-seek:search:2} shows the functions used to find the target key by a search operation. The function \SeekForSearch{} (\linesref{local-seek|search:begin}{local-seek|search:end}) first traverses the tree starting from the root node (\lineref{local-seek|search:traverse|tree}). If the traversal fails to locate the key, then the key may have moved up the tree. To address this possibility, the function examines the traversal stack to determine whether or not that is the case (\lineref{local-seek|search:examine|stack}). The function \TraverseTree{} (\linesref{local-traverse|tree:begin}{local-traverse|tree:end}) first initializes the traversal stack (\lineref{local-traverse|tree:initialize}) and then, starting from the topmost node in the stack (\lineref{local-traverse|tree:start}), follows either the left or the right child pointer (\lineref{local-traverse|tree:select}) until it either finds the key (\lineref{local-traverse|tree:match}) or encounters a null pointer (\lineref{local-traverse|tree:null}). It also populates the traversal stack as it moves (\lineref{local-traverse|tree:stack}). The function \ExamineStack (\linesref{local-examine|stack:begin}{local-examine|stack:end}) examines the \myanchor{} nodes stored in the stack in the reverse order in which they were visited, starting from the \myanchor{} node closest to the topmost node in the traversal stack (\lineref{local-examine|stack:start}). If the \myanchor{} node's key matches the target key, then the function returns true (\linesref{local-examine|stack:while:found:begin}{local-examine|stack:while:found:end}). If the \myanchor{} node is no longer \myconsistent{} or is unmarked, then the function returns false (\linesref{local-examine|stack:while:not|found:begin}{local-examine|stack:while:not|found:end}). Otherwise, the function backtracks and examines the preceding \myanchor{} node in the stack (\linesref{local-examine|stack:while:continue:begin}{local-examine|stack:while:continue:end}).

\Pseudosref{local-local:recovery}{local-local:recovery:2} $\&$ ~\ref{algo:local-seek:modify} show the functions used to find the target key by a modify (insert or delete) operation. The function \SeekForModify{} (\linesref{local-seek|modify:begin}{local-seek|modify:end}) first backtracks to a \mysafe{} node in the stack (\lineref{local-seek|modify:while:find|start|point}). Initially, the starting point is typically a sentinel node which is a \mysafe{} node. The function then traverses the tree from top to down by following either the left or the right child pointer (\lineref{local-seek|modify:while:traversal:select}) until it either finds the key or encounters a null pointer (\linesref{local-seek|modify:while:traversal:stop:begin}{local-seek|modify:while:traversal:stop:end}). In case the terminal node's key is greater than the target key, the function checks whether the path stored in the traversal stack is still valid (\lineref{local-seek|modify:while:traversal:find|admissible}). If not, the traversal is restarted. As the traversal moves down the tree, the function also populates the traversal stack (\linesref{local-seek|modify:while:traversal:move:begin}{local-seek|modify:while:traversal:move:end}). The function \FindAdmissible{} (\linesref{local-find|admissible:begin}{local-find|admissible:end}) checks whether or not the path stored in the stack is still valid. To that end, it examines  the \myanchor{} nodes in the stack in the reverse order in which they were visited, starting from the \myanchor{} node closest to the topmost node in the traversal stack. There are three possible cases. First, the \myanchor{} node is still consistent (\linesref{local-find|admissible:while:consistent:begin}{local-find|admissible:while:consistent:end}). In this case, the path is deemed to be valid if the \myanchor{} node is unmarked; otherwise, the function moves to the preceding \myanchor{} node. Second, the \myanchor{} node is no longer consistent (\linesref{local-find|admissible:while:not|consistent:begin}{local-find|admissible:while:not|consistent:end}). In this case, the path is deemed to be invalid. However, if the operation is a delete operation, then it can be deduced that the key did not exist in the tree  continuously and the function returns indicating that the key was not found (thereby causing the operation to terminate). Finally, the \myanchor{} node's key matches the target key (\linesref{local-find|admissible:while:match:begin}{local-find|admissible:while:match:end}). In this case, if the \myanchor{} node is marked and the operation is a delete operation, then the path is deemed to be invalid (and further backtracking is required). This is because the key may be in the process of moving up the tree. Otherwise, the function returns indicating that the key was found. The function \FindStartPoint{} (\linesref{local-find|start|point:begin}{local-find|start|point:end}) finds a \mysafe{} node on the path stored in the stack from which the operation can restart its traversal. To that end, it backtracks to an unmarked node with a clean parent if required (\linesref{local-find|start|point:while:backtrack:begin}{local-find|start|point:while:backtrack:end}). It then checks whether or not the remaining path in the stack is still valid (\lineref{local-find|start|point:while:find|admissible}). If not, it repeats the above-mentioned steps.
